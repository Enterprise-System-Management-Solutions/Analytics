--
-- R_S_AND_D_REPORT_3  (Procedure) 
--
CREATE OR REPLACE PROCEDURE DWH_USER.R_S_AND_D_REPORT_3 IS
    VDATE_KEY       NUMBER;
BEGIN

SELECT DATE_KEY INTO VDATE_KEY
FROM DATE_DIM WHERE TO_CHAR(DATE_VALUE,'RRRRMMDD')=TO_CHAR(SYSDATE-1,'RRRRMMDD');



    --EXECUTE IMMEDIATE  'TRUNCATE TABLE PKPI DROP STORAGE';
    --EXECUTE IMMEDIATE 'ALTER TABLE PKPI TRUNCATE PARTITION PKPI_||VDATE_KEY DROP STORAGE';
    
DELETE S_AND_D_REPORT_3 WHERE DATE_KEY=VDATE_KEY;
COMMIT;
    
INSERT INTO S_AND_D_REPORT_3




SELECT A.V381_CALLINGCELLID,COALESCE (TOTAL_ACTIVE_SUBS, 0)TOTAL_ACTIVE_SUBS,COALESCE (ONLY_DATA_ACTIVE, 0)ONLY_DATA_ACTIVE,
       COALESCE (YOUTH_ACTIVE_SUBS, 0)YOUTH_ACTIVE_SUBS,COALESCE (AGAMI_ACTIVE_SUBS, 0)AGAMI_ACTIVE_SUBS,
       COALESCE (BORNOMALA_ACTIVE_SUBS, 0)BORNOMALA_ACTIVE_SUBS,COALESCE (SAGOTOM_ACTIVE_SUBS, 0)SAGOTOM_ACTIVE_SUBS,
       COALESCE (APARAJITA_ACTIVE_SUBS, 0)APARAJITA_ACTIVE_SUBS,COALESCE (MAYERHASHI_ACTIVE_SUBS, 0)MAYERHASHI_ACTIVE_SUBS,
       COALESCE (CORPORATE_ACTIVE_SUBS, 0)CORPORATE_ACTIVE_SUBS,COALESCE (MODEM_ACTIVE_SUBS, 0)MODEM_ACTIVE_SUBS,
       COALESCE (OTHER_ACTIVE_SUBS, 0)OTHER_ACTIVE_SUBS,VDATE_KEY
 FROM
 
(SELECT V381_CALLINGCELLID, COUNT(V372_CALLINGPARTYNUMBER) TOTAL_ACTIVE_SUBS 
FROM 
(
(select /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
from L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                     
AND V378_SERVICEFLOW=1
group by V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(select /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
from L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                     
AND V378_SERVICEFLOW=2
group by V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(select /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
from L3_DATA P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                     
group by G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID
)A

LEFT OUTER JOIN

(
SELECT G379_CALLINGCELLID, COUNT(G372_CALLINGPARTYNUMBER) ONLY_DATA_ACTIVE
FROM
(select /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
from L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                    
group by G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
group by G379_CALLINGCELLID
)B ON A.V381_CALLINGCELLID=B.G379_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) YOUTH_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID in (400014,400017,400016,300050)
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                   
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID in (400014,400017,400016,300050)
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
and G401_MAINOFFERINGID in (400014,400017,400016,300050)
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID
)C ON A.V381_CALLINGCELLID=C.V381_CALLINGCELLID

LEFT OUTER JOIN 

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) BORNOMALA_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                       
AND V378_SERVICEFLOW=1
AND V397_MAINOFFERINGID IN (300034,400015)
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                    
AND V378_SERVICEFLOW=2
AND V397_MAINOFFERINGID IN (300034,400015)
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                     
AND G401_MAINOFFERINGID IN (300034,400015)
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID
)D ON A.V381_CALLINGCELLID=D.V381_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) SAGOTOM_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID =479662
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                    
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID =479662
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
and G401_MAINOFFERINGID =479662
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID
)E ON A.V381_CALLINGCELLID=E.V381_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) APARAJITA_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                       
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID =400019
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID =400019
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
and G401_MAINOFFERINGID =400019
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID
)F ON A.V381_CALLINGCELLID=F.V381_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) MAYERHASHI_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                   
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID =400018
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID =400018
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
and G401_MAINOFFERINGID =400018
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID


)G ON A.V381_CALLINGCELLID=G.V381_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) CORPORATE_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                    
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID in (200002,300022,300042,449066,449073,410010,410008,410009,449103,200001)
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                    
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID in (200002,300022,300042,449066,449073,410010,410008,410009,449103,200001)
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
and G401_MAINOFFERINGID in (200002,300022,300042,449066,449073,410010,410008,410009,449103,200001)
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID


)H ON A.V381_CALLINGCELLID=H.V381_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) MODEM_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                       
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID in (449066,449073,410013,449662,449103,400022,400021)
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                     
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID in (449066,449073,410013,449662,449103,400022,400021)
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA P
WHERE G383_CHARGINGTIME_KEY= (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                               
and G401_MAINOFFERINGID in (449066,449073,410013,449662,449103,400022,400021)
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID


)I ON A.V381_CALLINGCELLID=I.V381_CALLINGCELLID

LEFT OUTER JOIN

(
SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) OTHER_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND V378_SERVICEFLOW=1
and V397_MAINOFFERINGID NOT in (300033,400012,300034,400015,479662,400019,400018,200002,300022,300042,449066,449073,410010,410008,410009,449103,200001,400014,400017,400016,300050
,410013,449662,400022,400021)
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                       
AND V378_SERVICEFLOW=2
and V397_MAINOFFERINGID NOT in (300033,400012,300034,400015,479662,400019,400018,200002,300022,300042,449066,449073,410010,410008,410009,449103,200001,400014,400017,400016,300050
,410013,449662,400022,400021)
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
and G401_MAINOFFERINGID NOT in (300033,400012,300034,400015,479662,400019,400018,200002,300022,300042,449066,449073,410010,410008,410009,449103,200001,400014,400017,400016,300050
,410013,449662,400022,400021)
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID


)J ON A.V381_CALLINGCELLID=J.V381_CALLINGCELLID

LEFT OUTER JOIN

(SELECT V381_CALLINGCELLID,COUNT(V372_CALLINGPARTYNUMBER) AGAMI_ACTIVE_SUBS
FROM
(
(SELECT /*+PARALLEL(P,8)*/V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                    
AND V378_SERVICEFLOW=1
AND V397_MAINOFFERINGID IN (300033,400012)
GROUP BY V381_CALLINGCELLID, V372_CALLINGPARTYNUMBER
)

UNION

(SELECT /*+PARALLEL(P,8)*/V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER 
FROM L3_VOICE  P
WHERE V387_CHARGINGTIME_KEY =(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND V378_SERVICEFLOW=2
AND V397_MAINOFFERINGID IN (300033,400012)
GROUP BY V383_CALLEDCELLID, V373_CALLEDPARTYNUMBER
)


UNION

(SELECT /*+PARALLEL(P,8)*/G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER 
FROM L3_DATA  P
WHERE G383_CHARGINGTIME_KEY = (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR'))
                                                      
AND G401_MAINOFFERINGID IN (300033,400012)
GROUP BY G379_CALLINGCELLID, G372_CALLINGPARTYNUMBER
)
)
GROUP BY V381_CALLINGCELLID

)K ON A.V381_CALLINGCELLID=K.V381_CALLINGCELLID






;
    COMMIT;
END;
/

