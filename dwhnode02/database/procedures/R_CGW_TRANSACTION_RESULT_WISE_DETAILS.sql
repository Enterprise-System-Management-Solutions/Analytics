--
-- R_CGW_TRANSACTION_RESULT_WISE_DETAILS  (Procedure) 
--
CREATE OR REPLACE PROCEDURE DWH_USER.R_CGW_TRANSACTION_RESULT_WISE_DETAILS IS
    VDATE_KEY       VARCHAR2(64 BYTE);
BEGIN

SELECT DATE_KEY INTO VDATE_KEY
FROM DATE_DIM WHERE TO_CHAR(DATE_VALUE,'RRRRMMDD')=TO_CHAR(SYSDATE-1,'RRRRMMDD');



    --EXECUTE IMMEDIATE  'TRUNCATE TABLE PKPI DROP STORAGE';
    --EXECUTE IMMEDIATE 'ALTER TABLE PKPI TRUNCATE PARTITION PKPI_||VDATE_KEY DROP STORAGE';
    
DELETE CGW_TRANSACTION_RESULT_WISE_DETAILS WHERE DATE_KEY=VDATE_KEY;
COMMIT;
    
INSERT INTO CGW_TRANSACTION_RESULT_WISE_DETAILS



SELECT DATE_VALUE,CGW10_RESULT_CODE,TRANSACTION_RESULT,SUM(TRANSACTION_COUNT) TRANSACTION_COUNT,SUM(CGW14_AMOUNT) CGW14_AMOUNT,VDATE_KEY
FROM DATE_DIM Q,
(SELECT /*+PARALLEL(P,15)*/CGW15_TRANSACTION_TIME_KEY,CGW10_RESULT_CODE,

         COUNT(*) TRANSACTION_COUNT,SUM(CGW14_AMOUNT) CGW14_AMOUNT,
         CASE 
WHEN LENGTH(CGW11_RESULT_DESC)<80
THEN CGW11_RESULT_DESC
WHEN LENGTH(CGW11_RESULT_DESC)=80
THEN CONCAT(SUBSTR(CGW11_RESULT_DESC,1,54),SUBSTR(CGW11_RESULT_DESC,66,15))
END TRANSACTION_RESULT
FROM L3_CGW P
WHERE CGW15_TRANSACTION_TIME_KEY IN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE >= TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
GROUP BY CGW15_TRANSACTION_TIME_KEY, CGW10_RESULT_CODE,CGW11_RESULT_DESC
)P
WHERE Q.DATE_KEY=P.CGW15_TRANSACTION_TIME_KEY
GROUP BY DATE_VALUE,CGW10_RESULT_CODE,TRANSACTION_RESULT;
      COMMIT;
END;
/

