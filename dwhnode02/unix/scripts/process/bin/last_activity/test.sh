export ORACLE_UNQNAME=DWH05
export ORACLE_BASE=/data01/app/oracle
export ORACLE_HOME=/data01/app/oracle/product/12.2.0/db_1
export ORACLE_SID=DWH05

PATH=/usr/sbin:$PATH:$ORACLE_HOME/bin

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib;
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib;


sqlplus  -s <<EOF
dwh_user/dwh_user_123
SET echo off
SET head off
SET feedback off
REM "WHENEVER SQLERROR EXIT SQL.SQLCODE"
MERGE INTO /*+ PARALLEL (A,16) */  LAST_ACTIVITY_FCT_LD A
USING (SELECT /*+ PARALLEL (X,16) */ X.MSISDN, X.DATE_KEY, X.TIME_KEY,X.PRODUCT_KEY,X.GEOGRAPHY_KEY
FROM
(SELECT /*+ PARALLEL (Z,16) */  Z.MSISDN, Z.DATE_KEY,Z.TIME_KEY,Z.PRODUCT_KEY,Z.GEOGRAPHY_KEY,RANK() OVER (PARTITION BY Z.MSISDN ORDER BY Z.DATE_KEY DESC,Z.TIME_KEY DESC) LAST_KEY
FROM
(SELECT /*+ PARALLEL (A,16) */  A.MSISDN, MAX(A.DATE_KEY) AS DATE_KEY ,MAX(A.TIME_KEY) AS TIME_KEY,MAX(A.PRODUCT_KEY) AS PRODUCT_KEY,MAX(A.GEOGRAPHY_KEY) AS GEOGRAPHY_KEY
FROM
(SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LU_MOC_DATE_KEY,0) AS DATE_KEY ,
NVL(LU_MOC_TIME_KEY,0) AS TIME_KEY,
NVL(LU_MOC_PRODUCT_KEY,0) AS PRODUCT_KEY,
NVL(LU_MOC_GEOGRAPHY_KEY,0) AS GEOGRAPHY_KEY
FROM 
LAST_ACTIVITY_FCT_LD
UNION ALL
SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LU_MTC_DATE_KEY,0) AS DATE_KEY ,
NVL(LU_MTC_TIME_KEY,0) AS TIME_KEY,
NVL(LU_MTC_PRODUCT_KEY,0) AS PRODUCT_KEY,
NVL(LU_MTC_GEOGRAPHY_KEY,0) AS GEOGRAPHY_KEY
FROM 
LAST_ACTIVITY_FCT_LD
UNION ALL
SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LU_ON_NET_MOC_DATE_KEY,0) AS DATE_KEY ,
NVL(LU_ON_NET_MOC_TIME_KEY,0) AS TIME_KEY,
NVL(LU_ON_NET_MOC_PRODUCT_KEY,0) AS PRODUCT_KEY,
NULL AS GEOGRAPHY_KEY
FROM 
LAST_ACTIVITY_FCT_LD
UNION ALL
SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LU_OFF_NET_MOC_DATE_KEY,0) AS DATE_KEY ,
NVL(LU_OFF_NET_MOC_TIME_KEY,0) AS TIME_KEY,
NVL(LU_OFF_NET_MOC_PRODUCT_KEY,0) AS PRODUCT_KEY,
NVL(LU_OFF_NET_MOC_LOCATION_KEY,0) AS GEOGRAPHY_KEY    
FROM 
LAST_ACTIVITY_FCT_LD
UNION ALL
SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LU_MOSMS_DATE_KEY,0) AS DATE_KEY ,
NVL(LU_MOSMS_TIME_KEY,0) AS TIME_KEY,
NVL(LU_MOSMS_PRODUCT_KEY,0) AS PRODUCT_KEY,
NULL AS GEOGRAPHY_KEY
FROM 
LAST_ACTIVITY_FCT_LD
UNION ALL
SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LU_GPRS_DATE_KEY,0) AS DATE_KEY ,
NVL(LU_GPRS_TIME_KEY,0) AS TIME_KEY,
NVL(LU_GPRS_PRODUCT_KEY,0) AS PRODUCT_KEY,
NVL(LU_GPRS_GEOGRAPHY_KEY,0) AS GEOGRAPHY_KEY
FROM 
LAST_ACTIVITY_FCT_LD
UNION ALL
SELECT/*+ PARALLEL (LAST_ACTIVITY_FCT_LD,16) */ MSISDN,
NVL(LR_DATE_KEY,0) AS DATE_KEY ,
NVL(LR_TIME_KEY,0) AS TIME_KEY,
NULL AS PRODUCT_KEY,
NULL AS GEOGRAPHY_KEY
FROM 
LAST_ACTIVITY_FCT_LD)A
GROUP BY A.MSISDN
)Z
)X
WHERE X.LAST_KEY=1
)T
ON (A.MSISDN = T.MSISDN) 
WHEN MATCHED THEN
UPDATE SET A.LU_DATE_KEY=T.DATE_KEY,
   A.LU_TIME_KEY =T.TIME_KEY,
   A.LU_PRODUCT_KEY=T.PRODUCT_KEY,
   A.LU_LOCATION_KEY=T.GEOGRAPHY_KEY;
COMMIT;
EXIT
EOF

